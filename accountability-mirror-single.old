<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accountability Mirror</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e12;
            --bg-secondary: #141921;
            --bg-tertiary: #1d2530;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --border: #2d3748;
            --protein-color: #ef4444;
            --carbs-color: #f59e0b;
            --fat-color: #10b981;
            --system-msg: #1e293b;
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            overflow-y: auto;
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }

        .tagline {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            font-style: italic;
        }

        .daily-stats {
            margin-top: 2rem;
            flex: 1;
        }

        .date-display {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .date-display .day {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .date-display .full-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .macro-summary h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .macro-bars {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .macro-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .macro-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .macro-label span:first-child {
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .macro-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .macro-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .macro-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .protein-fill {
            background: var(--protein-color);
        }

        .carbs-fill {
            background: var(--carbs-color);
        }

        .fat-fill {
            background: var(--fat-color);
        }

        .calories-display {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 1.5rem;
        }

        .cal-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .cal-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .action-btn {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Crimson Pro', serif;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-align: left;
        }

        .action-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
        }

        .settings-link {
            margin-top: auto;
            padding-top: 1.5rem;
        }

        .settings-link button {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Crimson Pro', serif;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .settings-link button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            max-width: 700px;
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            font-size: 1.05rem;
        }

        .message-content p {
            margin-bottom: 0.75rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .system-message .message-content {
            background: var(--system-msg);
            border-left: 3px solid var(--accent);
        }

        .assistant-message .message-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .user-message .message-content {
            background: var(--accent);
            color: white;
            margin-left: auto;
        }

        .message-content strong {
            color: var(--accent);
            font-weight: 600;
        }

        .user-message .message-content strong {
            color: rgba(255, 255, 255, 0.95);
        }

        .message-content code {
            background: var(--bg-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        /* Chat Input */
        .chat-input-container {
            padding: 1.5rem 2rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            max-width: 900px;
            margin: 0 auto;
        }

        .photo-btn {
            width: 56px;
            height: 56px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .photo-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        #chat-input {
            flex: 1;
            padding: 1rem 1.25rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Crimson Pro', serif;
            font-size: 1.05rem;
            resize: none;
            min-height: 56px;
            max-height: 200px;
            line-height: 1.5;
            transition: border-color 0.2s ease;
        }

        #chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        #chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: 56px;
            height: 56px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group small {
            display: block;
            margin-top: 0.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        .save-btn {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-btn:hover {
            background: var(--accent-hover);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border);
        }

        /* Loading indicator */
        .typing-indicator {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-8px);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar with daily stats -->
        <aside class="sidebar">
            <div class="logo">
                <h1>Mirror</h1>
                <p class="tagline">Accountability in conversation</p>
            </div>
            
            <div class="daily-stats">
                <div class="date-display">
                    <span class="day"></span>
                    <span class="full-date"></span>
                </div>
                
                <div class="macro-summary">
                    <h3>Today's Macros</h3>
                    <div class="macro-bars">
                        <div class="macro-item">
                            <div class="macro-label">
                                <span>Protein</span>
                                <span class="macro-value"><span id="protein-current">0</span>/<span id="protein-target">120</span>g</span>
                            </div>
                            <div class="macro-bar">
                                <div class="macro-fill protein-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="macro-item">
                            <div class="macro-label">
                                <span>Carbs</span>
                                <span class="macro-value"><span id="carbs-current">0</span>/<span id="carbs-target">200</span>g</span>
                            </div>
                            <div class="macro-bar">
                                <div class="macro-fill carbs-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="macro-item">
                            <div class="macro-label">
                                <span>Fat</span>
                                <span class="macro-value"><span id="fat-current">0</span>/<span id="fat-target">60</span>g</span>
                            </div>
                            <div class="macro-bar">
                                <div class="macro-fill fat-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calories-display">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span class="cal-label">Calories</span>
                            <span class="cal-value"><span id="calories-current">0</span> / <span id="calories-target">2000</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-tertiary);">
                            <span id="deficit-label">Deficit</span>
                            <span id="deficit-value">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn" id="btn-today">How's today?</button>
                    <button class="action-btn" id="btn-suggestions">Meal suggestions</button>
                    <button class="action-btn" id="btn-supplements">About supplements</button>
                    <button class="action-btn" id="btn-check-safety">Check my supplements</button>
                </div>
            </div>
            
            <div class="settings-link">
                <button id="btn-settings">‚öô Settings</button>
            </div>
        </aside>
        
        <!-- Main chat area -->
        <main class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message system-message">
                    <div class="message-content">
                        <p>Welcome to your Accountability Mirror. I'm here to support your health and fitness journey with real-time advice, macro tracking, and motivation.</p>
                        <p>Tell me what you're eating, ask questions, share your struggles - let's work on this together.</p>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <input type="file" id="photo-input" accept="image/*" style="display: none;">
                    <button id="photo-btn" class="photo-btn" title="Upload food photo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                    </button>
                    <textarea 
                        id="chat-input" 
                        placeholder="Tell me what you ate, ask a question, or share how you're feeling..."
                        rows="1"
                    ></textarea>
                    <button id="send-btn" class="send-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                </div>
                <div id="photo-preview" style="display: none; margin-top: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 8px;">
                        <img id="preview-img" style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                        <span id="preview-name" style="flex: 1; font-size: 0.9rem; color: var(--text-secondary);"></span>
                        <button id="remove-photo" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" id="close-settings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>API Configuration</h3>
                    <div class="form-group">
                        <label for="api-provider">AI Provider</label>
                        <select id="api-provider">
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="openai">ChatGPT (OpenAI)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="api-key">API Key</label>
                        <input type="password" id="api-key" placeholder="Enter your API key">
                        <small>Your API key is stored locally and never sent anywhere except to the chosen provider.</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Daily Macro Targets</h3>
                    <div class="form-group">
                        <label for="target-protein">Protein (g)</label>
                        <input type="number" id="target-protein" value="120">
                        <small>Aim for 1.6-2.2g per kg bodyweight for muscle preservation</small>
                    </div>
                    <div class="form-group">
                        <label for="target-carbs">Carbs (g)</label>
                        <input type="number" id="target-carbs" value="200">
                    </div>
                    <div class="form-group">
                        <label for="target-fat">Fat (g)</label>
                        <input type="number" id="target-fat" value="60">
                        <small>Minimum 0.5g per kg bodyweight for hormones</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Calorie Goal</h3>
                    <div class="form-group">
                        <label for="maintenance-calories">Maintenance Calories (TDEE)</label>
                        <input type="number" id="maintenance-calories" value="2500" placeholder="e.g. 2500">
                        <small>Your estimated daily calorie burn. Use a TDEE calculator if unsure.</small>
                    </div>
                    <div class="form-group">
                        <label for="calorie-goal">Daily Calorie Goal</label>
                        <input type="number" id="calorie-goal" value="2000" placeholder="e.g. 2000">
                        <small>For weight loss: 300-500 below maintenance. For muscle gain: 200-300 above.</small>
                    </div>
                    <div class="form-group">
                        <label>Target Deficit/Surplus</label>
                        <input type="text" id="calculated-deficit" readonly style="background: var(--bg-tertiary); cursor: not-allowed;" value="500 deficit">
                        <small>Calculated automatically. ~0.5kg/week loss per 500 cal deficit.</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Personal Context</h3>
                    <div class="form-group">
                        <label for="user-age">Age</label>
                        <input type="number" id="user-age" placeholder="e.g. 45">
                    </div>
                    <div class="form-group">
                        <label for="user-weight">Current Weight (kg)</label>
                        <input type="number" id="user-weight" placeholder="e.g. 80" step="0.1">
                        <small>Optional - helps with protein calculations</small>
                    </div>
                    <div class="form-group">
                        <label for="user-goals">Primary Goals</label>
                        <textarea id="user-goals" rows="3" placeholder="e.g. Lose 10kg, build muscle, improve energy, better sleep quality..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="user-context">Additional Context</label>
                        <textarea id="user-context" rows="4" placeholder="Work schedule, dietary preferences, fitness level, any limitations..."></textarea>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Medications & Supplements</h3>
                    <div class="form-group">
                        <label for="user-medications">Current Medications</label>
                        <textarea id="user-medications" rows="3" placeholder="e.g. Tamoxifen 20mg daily, Levothyroxine 50mcg..."></textarea>
                        <small>‚ö†Ô∏è List all prescription medications - this helps check for supplement interactions</small>
                    </div>
                    <div class="form-group">
                        <label for="user-supplements">Current Supplements</label>
                        <textarea id="user-supplements" rows="4" placeholder="e.g. Vitamin D 2000IU, Omega-3 1000mg, Creatine 5g, Magnesium glycinate 400mg..."></textarea>
                        <small>List everything you take - vitamins, minerals, herbs, protein powder, etc.</small>
                    </div>
                    <div class="form-group">
                        <label for="user-conditions">Medical Conditions / Allergies</label>
                        <textarea id="user-conditions" rows="2" placeholder="e.g. Breast cancer (on Tamoxifen), hypothyroidism, allergies to..."></textarea>
                        <small>Optional - helps with personalized advice and safety checks</small>
                    </div>
                </div>
                
                <button class="save-btn" id="save-settings">Save Settings</button>
            </div>
        </div>
    </div>
    
    <script>
        // State management
        const state = {
            macros: {
                protein: { current: 0, target: 120 },
                carbs: { current: 0, target: 200 },
                fat: { current: 0, target: 60 }
            },
            calories: { current: 0, target: 2000, maintenance: 2500 },
            conversationHistory: [],
            uploadedPhoto: null, // Store photo for next message
            settings: {
                apiProvider: 'claude',
                apiKey: '',
                userAge: '',
                userWeight: '',
                userGoals: '',
                userContext: '',
                userMedications: '',
                userSupplements: '',
                userConditions: ''
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
            loadSettings();
            updateDateDisplay();
            loadTodaysMacros();
        });

        function initializeApp() {
            console.log('Accountability Mirror initialized');
        }

        // Event Listeners
        function setupEventListeners() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            sendBtn.addEventListener('click', () => {
                handleSendMessage();
            });
            
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            
            // Auto-resize textarea
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = chatInput.scrollHeight + 'px';
            });
            
            // Quick action buttons
            document.getElementById('btn-today').addEventListener('click', () => {
                sendPredefinedMessage("How am I doing today? Give me a summary of my progress and any suggestions.");
            });
            
            document.getElementById('btn-suggestions').addEventListener('click', () => {
                sendPredefinedMessage("Based on my current macros, what should I eat next to stay on track?");
            });
            
            document.getElementById('btn-supplements').addEventListener('click', () => {
                sendPredefinedMessage("Tell me about supplements that are actually evidence-based and worth taking for my goals.");
            });
            
            document.getElementById('btn-check-safety').addEventListener('click', () => {
                if (!state.settings.userMedications && !state.settings.userSupplements) {
                    sendPredefinedMessage("I'd like to check for supplement safety, but I haven't entered my medications or supplements yet. What should I do?");
                } else {
                    sendPredefinedMessage("Please review my current medications and supplements for any dangerous interactions or contraindications. Flag anything I should be concerned about, especially related to my medications.");
                }
            });
            
            // Settings
            document.getElementById('btn-settings').addEventListener('click', () => {
                openSettings();
            });
            
            document.getElementById('close-settings').addEventListener('click', () => {
                closeSettings();
            });
            
            document.getElementById('save-settings').addEventListener('click', () => {
                saveSettings();
            });
            
            // Close modal on outside click
            document.getElementById('settings-modal').addEventListener('click', (e) => {
                if (e.target.id === 'settings-modal') {
                    closeSettings();
                }
            });
            
            // Update deficit calculation when calorie fields change
            document.getElementById('maintenance-calories').addEventListener('input', updateDeficitCalculation);
            document.getElementById('calorie-goal').addEventListener('input', updateDeficitCalculation);
            
            // Photo upload
            document.getElementById('photo-btn').addEventListener('click', () => {
                document.getElementById('photo-input').click();
            });
            
            document.getElementById('photo-input').addEventListener('change', handlePhotoUpload);
            
            document.getElementById('remove-photo').addEventListener('click', () => {
                state.uploadedPhoto = null;
                document.getElementById('photo-preview').style.display = 'none';
                document.getElementById('photo-input').value = '';
            });
        }

        // Date display
        function updateDateDisplay() {
            const now = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.querySelector('.date-display .day').textContent = days[now.getDay()];
            document.querySelector('.date-display .full-date').textContent = 
                `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
        }
        
        // Photo handling
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }
            
            // Read file as base64
            const reader = new FileReader();
            reader.onload = (e) => {
                state.uploadedPhoto = {
                    data: e.target.result.split(',')[1], // Get base64 part only
                    type: file.type,
                    name: file.name
                };
                
                // Show preview
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-name').textContent = file.name;
                document.getElementById('photo-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Macro management
        function loadTodaysMacros() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem(`macros_${today}`);
            
            if (stored) {
                const data = JSON.parse(stored);
                state.macros = data;
                updateMacroDisplay();
            } else {
                state.macros.protein.current = 0;
                state.macros.carbs.current = 0;
                state.macros.fat.current = 0;
                state.calories.current = 0;
                updateMacroDisplay();
            }
        }

        function saveTodaysMacros() {
            const today = new Date().toDateString();
            localStorage.setItem(`macros_${today}`, JSON.stringify(state.macros));
        }

        function updateMacros(protein, carbs, fat) {
            state.macros.protein.current += protein;
            state.macros.carbs.current += carbs;
            state.macros.fat.current += fat;
            
            state.calories.current = Math.round(
                (state.macros.protein.current * 4) +
                (state.macros.carbs.current * 4) +
                (state.macros.fat.current * 9)
            );
            
            updateMacroDisplay();
            saveTodaysMacros();
        }

        function updateMacroDisplay() {
            document.getElementById('protein-current').textContent = Math.round(state.macros.protein.current);
            document.getElementById('protein-target').textContent = state.macros.protein.target;
            const proteinPercent = Math.min((state.macros.protein.current / state.macros.protein.target) * 100, 100);
            document.querySelector('.protein-fill').style.width = `${proteinPercent}%`;
            
            document.getElementById('carbs-current').textContent = Math.round(state.macros.carbs.current);
            document.getElementById('carbs-target').textContent = state.macros.carbs.target;
            const carbsPercent = Math.min((state.macros.carbs.current / state.macros.carbs.target) * 100, 100);
            document.querySelector('.carbs-fill').style.width = `${carbsPercent}%`;
            
            document.getElementById('fat-current').textContent = Math.round(state.macros.fat.current);
            document.getElementById('fat-target').textContent = state.macros.fat.target;
            const fatPercent = Math.min((state.macros.fat.current / state.macros.fat.target) * 100, 100);
            document.querySelector('.fat-fill').style.width = `${fatPercent}%`;
            
            document.getElementById('calories-current').textContent = state.calories.current;
            document.getElementById('calories-target').textContent = state.calories.target;
            
            // Calculate and display deficit/surplus
            const remaining = state.calories.target - state.calories.current;
            const deficitLabel = document.getElementById('deficit-label');
            const deficitValue = document.getElementById('deficit-value');
            
            if (remaining > 0) {
                deficitLabel.textContent = 'Remaining';
                deficitValue.textContent = `${remaining} cal`;
                deficitValue.style.color = 'var(--carbs-color)';
            } else if (remaining < 0) {
                deficitLabel.textContent = 'Over target';
                deficitValue.textContent = `${Math.abs(remaining)} cal`;
                deficitValue.style.color = 'var(--protein-color)';
            } else {
                deficitLabel.textContent = 'Perfect!';
                deficitValue.textContent = 'On target';
                deficitValue.style.color = 'var(--fat-color)';
            }
        }

        // Chat functionality
        async function handleSendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            // Allow sending if there's a message OR a photo
            if (!message && !state.uploadedPhoto) return;
            
            if (!state.settings.apiKey) {
                addAssistantMessage("Please configure your API key in Settings first. Click the ‚öô Settings button on the left.");
                return;
            }
            
            // Add user message to chat
            if (state.uploadedPhoto) {
                addUserMessage(message || 'üì∑ Uploaded food photo', true);
            } else {
                addUserMessage(message);
            }
            
            input.value = '';
            input.style.height = 'auto';
            
            showTypingIndicator();
            
            try {
                const response = await getAIResponse(message);
                removeTypingIndicator();
                addAssistantMessage(response.message);
                
                if (response.macros) {
                    updateMacros(response.macros.protein, response.macros.carbs, response.macros.fat);
                }
            } catch (error) {
                removeTypingIndicator();
                addAssistantMessage(`Sorry, I encountered an error: ${error.message}. Please check your API key in Settings.`);
            }
        }

        function sendPredefinedMessage(message) {
            document.getElementById('chat-input').value = message;
            handleSendMessage();
        }

        function addUserMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <p>${escapeHtml(text)}</p>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            state.conversationHistory.push({
                role: 'user',
                content: text
            });
        }

        function addAssistantMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message';
            
            const formattedText = formatMessage(text);
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${formattedText}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            state.conversationHistory.push({
                role: 'assistant',
                content: text
            });
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const indicator = document.createElement('div');
            indicator.className = 'message assistant-message typing-message';
            indicator.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            messagesContainer.appendChild(indicator);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.querySelector('.typing-message');
            if (indicator) {
                indicator.remove();
            }
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // AI API Integration
        async function getAIResponse(userMessage) {
            const systemPrompt = buildSystemPrompt();
            
            if (state.settings.apiProvider === 'claude') {
                return await getClaudeResponse(systemPrompt, userMessage);
            } else {
                return await getOpenAIResponse(systemPrompt, userMessage);
            }
        }

        function buildSystemPrompt() {
            const deficit = state.calories.maintenance - state.calories.target;
            const deficitText = deficit > 0 
                ? `${deficit} cal deficit for ~${(deficit / 500 * 0.5).toFixed(1)}kg/week loss` 
                : deficit < 0 
                    ? `${Math.abs(deficit)} cal surplus for muscle gain`
                    : 'maintenance calories';
            
            const currentMacros = `
Current macros today:
- Protein: ${Math.round(state.macros.protein.current)}g / ${state.macros.protein.target}g
- Carbs: ${Math.round(state.macros.carbs.current)}g / ${state.macros.carbs.target}g
- Fat: ${Math.round(state.macros.fat.current)}g / ${state.macros.fat.target}g
- Calories: ${state.calories.current} / ${state.calories.target} (${deficitText})
`;

            const medicationInfo = state.settings.userMedications || state.settings.userSupplements || state.settings.userConditions
                ? `
CRITICAL MEDICATION & SUPPLEMENT SAFETY INFORMATION:
${state.settings.userMedications ? `Current Medications: ${state.settings.userMedications}` : ''}
${state.settings.userSupplements ? `Current Supplements: ${state.settings.userSupplements}` : ''}
${state.settings.userConditions ? `Medical Conditions: ${state.settings.userConditions}` : ''}

IMPORTANT SAFETY RULES:
- ALWAYS check for drug-supplement interactions before recommending supplements
- For Tamoxifen users: DO NOT recommend black pepper/piperine, curcumin/turmeric supplements, ashwagandha, St John's Wort, or high-dose antioxidants (can interfere with treatment)
- If user asks about supplements, cross-check against their medications and WARN about any potential interactions
- When analyzing uploaded supplement photos, flag any contraindications immediately
- Be especially cautious with: blood thinners, hormone therapies, immunosuppressants, thyroid medications
- Encourage consulting with oncologist/doctor before starting ANY new supplement when on serious medications
`
                : '';

            const userContext = state.settings.userAge || state.settings.userWeight || state.settings.userGoals || state.settings.userContext
                ? `
User context:
${state.settings.userAge ? `- Age: ${state.settings.userAge}` : ''}
${state.settings.userWeight ? `- Weight: ${state.settings.userWeight}kg` : ''}
${state.settings.userGoals ? `- Goals: ${state.settings.userGoals}` : ''}
${state.settings.userContext ? `- Additional context: ${state.settings.userContext}` : ''}
`
                : '';

            return `You are an accountability coach for health, fitness, and nutrition. You provide supportive, evidence-based guidance with a conversational, motivating tone.

${currentMacros}

${medicationInfo}

${userContext}

When the user mentions food they've eaten:
1. Estimate the macros (protein, carbs, fat in grams)
2. Provide feedback on how it fits their goals
3. Respond with your message AND include macro data in this exact format at the end:
   MACROS: protein=X carbs=Y fat=Z

For example: "That's a great breakfast choice! Scrambled eggs with toast gives you solid protein to start the day.

MACROS: protein=25 carbs=30 fat=15"

When analyzing uploaded photos of food labels or supplements:
1. Read all visible text carefully
2. Extract macros if it's a food label
3. If it's a supplement label, check ingredients against their medications
4. Warn immediately about any contraindications or interactions

Guidelines:
- Be supportive and realistic, not preachy
- Offer practical swaps and suggestions
- Consider their age, goals, and context
- Be honest about what works and what doesn't
- PRIORITIZE SAFETY: Always check supplement-medication interactions
- When discussing supplements, focus on evidence-based options that are SAFE for their medication profile
- Help them make decisions in the moment (temptations, cravings, fatigue)
- Celebrate progress and consistency over perfection
- Use UK terminology and foods

Keep responses conversational and not too long unless they ask for detailed information.`;
        }

        async function getClaudeResponse(systemPrompt, userMessage) {
            console.log('=== Claude API Call Debug ===');
            console.log('API Key (first 10 chars):', state.settings.apiKey.substring(0, 10));
            console.log('Has photo:', !!state.uploadedPhoto);
            
            // Build message content
            let messageContent;
            if (state.uploadedPhoto) {
                // Multi-part message with image
                messageContent = [
                    {
                        type: 'image',
                        source: {
                            type: 'base64',
                            media_type: state.uploadedPhoto.type,
                            data: state.uploadedPhoto.data
                        }
                    },
                    {
                        type: 'text',
                        text: userMessage || 'Please analyze this food label and tell me the macros (protein, carbs, fat in grams). If it shows serving size, tell me that too.'
                    }
                ];
            } else {
                // Text-only message
                messageContent = userMessage;
            }
            
            const messages = [
                ...state.conversationHistory.slice(-10),
                { role: 'user', content: messageContent }
            ];
            
            // Use local proxy to avoid CORS issues
            const apiUrl = '/api/claude';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: systemPrompt,
                        messages: messages,
                        apiKey: state.settings.apiKey
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`API Error: ${errorJson.error?.message || errorText}`);
                    } catch (e) {
                        throw new Error(`API request failed (${response.status}): ${errorText}`);
                    }
                }
                
                const data = await response.json();
                console.log('API response received successfully');
                const messageText = data.content[0].text;
                
                // Clear uploaded photo after successful send
                state.uploadedPhoto = null;
                document.getElementById('photo-preview').style.display = 'none';
                document.getElementById('photo-input').value = '';
                
                return parseAIResponse(messageText);
                
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function getOpenAIResponse(systemPrompt, userMessage) {
            const messages = [
                { role: 'system', content: systemPrompt },
                ...state.conversationHistory.slice(-10),
                { role: 'user', content: userMessage }
            ];
            
            // Use CORS proxy for local file access
            const corsProxy = 'https://corsproxy.io/?';
            const apiUrl = corsProxy + encodeURIComponent('https://api.openai.com/v1/chat/completions');
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.settings.apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: messages,
                    max_tokens: 1024
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.statusText}`);
            }
            
            const data = await response.json();
            const messageText = data.choices[0].message.content;
            
            return parseAIResponse(messageText);
        }

        function parseAIResponse(text) {
            const macroMatch = text.match(/MACROS:\s*protein=(\d+(?:\.\d+)?)\s*carbs=(\d+(?:\.\d+)?)\s*fat=(\d+(?:\.\d+)?)/i);
            
            let macros = null;
            let message = text;
            
            if (macroMatch) {
                macros = {
                    protein: parseFloat(macroMatch[1]),
                    carbs: parseFloat(macroMatch[2]),
                    fat: parseFloat(macroMatch[3])
                };
                
                message = text.replace(/MACROS:.*$/i, '').trim();
            }
            
            return { message, macros };
        }

        // Settings management
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            loadSettingsToForm();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function loadSettings() {
            const stored = localStorage.getItem('settings');
            if (stored) {
                state.settings = { ...state.settings, ...JSON.parse(stored) };
            }
            
            const storedTargets = localStorage.getItem('macroTargets');
            if (storedTargets) {
                const targets = JSON.parse(storedTargets);
                state.macros.protein.target = targets.protein;
                state.macros.carbs.target = targets.carbs;
                state.macros.fat.target = targets.fat;
                state.calories.target = targets.calories || targets.calorieTarget || 2000;
                state.calories.maintenance = targets.maintenance || 2500;
                updateMacroDisplay();
            }
        }

        function loadSettingsToForm() {
            document.getElementById('api-provider').value = state.settings.apiProvider;
            document.getElementById('api-key').value = state.settings.apiKey;
            document.getElementById('target-protein').value = state.macros.protein.target;
            document.getElementById('target-carbs').value = state.macros.carbs.target;
            document.getElementById('target-fat').value = state.macros.fat.target;
            document.getElementById('maintenance-calories').value = state.calories.maintenance;
            document.getElementById('calorie-goal').value = state.calories.target;
            document.getElementById('user-age').value = state.settings.userAge || '';
            document.getElementById('user-weight').value = state.settings.userWeight || '';
            document.getElementById('user-goals').value = state.settings.userGoals || '';
            document.getElementById('user-context').value = state.settings.userContext || '';
            document.getElementById('user-medications').value = state.settings.userMedications || '';
            document.getElementById('user-supplements').value = state.settings.userSupplements || '';
            document.getElementById('user-conditions').value = state.settings.userConditions || '';
            
            // Update calculated deficit field
            updateDeficitCalculation();
        }
        
        function updateDeficitCalculation() {
            const maintenance = parseInt(document.getElementById('maintenance-calories').value) || 2500;
            const goal = parseInt(document.getElementById('calorie-goal').value) || 2000;
            const diff = maintenance - goal;
            const deficitField = document.getElementById('calculated-deficit');
            
            if (diff > 0) {
                deficitField.value = `${diff} cal deficit (~${(diff / 500 * 0.5).toFixed(1)}kg/week loss)`;
            } else if (diff < 0) {
                deficitField.value = `${Math.abs(diff)} cal surplus (~${(Math.abs(diff) / 500 * 0.5).toFixed(1)}kg/week gain)`;
            } else {
                deficitField.value = 'Maintenance (no change)';
            }
        }

        function saveSettings() {
            state.settings.apiProvider = document.getElementById('api-provider').value;
            state.settings.apiKey = document.getElementById('api-key').value;
            state.settings.userAge = document.getElementById('user-age').value;
            state.settings.userWeight = document.getElementById('user-weight').value;
            state.settings.userGoals = document.getElementById('user-goals').value;
            state.settings.userContext = document.getElementById('user-context').value;
            state.settings.userMedications = document.getElementById('user-medications').value;
            state.settings.userSupplements = document.getElementById('user-supplements').value;
            state.settings.userConditions = document.getElementById('user-conditions').value;
            
            localStorage.setItem('settings', JSON.stringify(state.settings));
            
            state.macros.protein.target = parseInt(document.getElementById('target-protein').value);
            state.macros.carbs.target = parseInt(document.getElementById('target-carbs').value);
            state.macros.fat.target = parseInt(document.getElementById('target-fat').value);
            state.calories.maintenance = parseInt(document.getElementById('maintenance-calories').value);
            state.calories.target = parseInt(document.getElementById('calorie-goal').value);
            
            const targets = {
                protein: state.macros.protein.target,
                carbs: state.macros.carbs.target,
                fat: state.macros.fat.target,
                calories: state.calories.target,
                maintenance: state.calories.maintenance
            };
            
            localStorage.setItem('macroTargets', JSON.stringify(targets));
            
            updateMacroDisplay();
            closeSettings();
            
            addAssistantMessage("Settings saved! I'm ready to help you with your goals.");
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            const paragraphs = text.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                p = p.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                p = p.replace(/__(.+?)__/g, '<strong>$1</strong>');
                p = p.replace(/`(.+?)`/g, '<code>$1</code>');
                
                return `<p>${p}</p>`;
            }).join('');
        }
    </script>
</body>
</html>
