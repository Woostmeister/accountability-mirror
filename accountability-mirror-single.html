<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accountability Mirror</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='6' y='4' width='20' height='24' rx='2' fill='%231a1f29' stroke='%235b8ef4' stroke-width='2'/%3E%3Cpath d='M8 6 L24 6 L24 26 L8 26 Z' fill='url(%23gradient)'/%3E%3Cpath d='M12 16 L15 19 L21 13' stroke='%235b8ef4' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cdefs%3E%3ClinearGradient id='gradient' x1='8' y1='6' x2='24' y2='26' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0%25' stop-color='%23252b38' stop-opacity='0.8'/%3E%3Cstop offset='50%25' stop-color='%231a1f29' stop-opacity='0.6'/%3E%3Cstop offset='100%25' stop-color='%230f1419' stop-opacity='0.9'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f29;
            --bg-tertiary: #252b38;
            --text-primary: #f0f2f5;
            --text-secondary: #b4bac6;
            --text-tertiary: #7d8694;
            --accent: #5b8ef4;
            --accent-hover: #7ca5f6;
            --border: #2d3543;
            --protein-color: #ff6b9d;
            --carbs-color: #ffa94d;
            --fat-color: #51cf66;
            --system-msg: rgba(91, 142, 244, 0.08);
            --success: #51cf66;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            overflow-y: auto;
        }

        .logo h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        .daily-stats {
            margin-top: 2rem;
            flex: 1;
        }

        .date-display {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            margin-bottom: 1.75rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .date-display .day {
            font-size: 1.375rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .date-display .full-date {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .macro-summary h3 {
            font-size: 0.6875rem;
            margin-bottom: 1.25rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .macro-bars {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .macro-item {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .macro-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8125rem;
            font-family: 'JetBrains Mono', monospace;
            align-items: baseline;
        }

        .macro-label span:first-child {
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .macro-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .macro-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .macro-fill {
            height: 100%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 3px;
            position: relative;
        }

        .macro-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 3px 3px 0 0;
        }

        .protein-fill {
            background: linear-gradient(90deg, var(--protein-color) 0%, rgba(255, 107, 157, 0.8) 100%);
        }

        .carbs-fill {
            background: linear-gradient(90deg, var(--carbs-color) 0%, rgba(255, 169, 77, 0.8) 100%);
        }

        .fat-fill {
            background: linear-gradient(90deg, var(--fat-color) 0%, rgba(81, 207, 102, 0.8) 100%);
        }

        .calories-display {
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(43, 50, 65, 0.6) 100%);
            border-radius: 10px;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 1.75rem;
            border: 1px solid rgba(91, 142, 244, 0.1);
        }

        .cal-label {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .cal-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .weekly-summary {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .weekly-summary h3 {
            font-size: 0.6875rem;
            margin-bottom: 1rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .week-dates {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .weekly-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--bg-tertiary);
            padding: 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .weekly-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-family: 'JetBrains Mono', monospace;
        }

        .weekly-stat-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .weekly-stat-value {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 0.9375rem;
            letter-spacing: -0.01em;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .action-btn {
            padding: 0.875rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .settings-link {
            margin-top: auto;
            padding-top: 1.5rem;
        }

        .settings-link button {
            width: 100%;
            padding: 0.875rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-link button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            max-width: 700px;
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            font-size: 1.05rem;
            position: relative;
        }

        .message-content p {
            margin-bottom: 0.75rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .copy-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.4rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .copy-btn:hover {
            opacity: 1;
            background: var(--bg-primary);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .copy-label {
            font-size: 0.75rem;
        }

        .system-message .message-content {
            background: var(--system-msg);
            border-left: 3px solid var(--accent);
        }

        .assistant-message .message-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .user-message .message-content {
            background: var(--accent);
            color: white;
            margin-left: auto;
        }

        .message-content strong {
            color: var(--accent);
            font-weight: 600;
        }

        .user-message .message-content strong {
            color: rgba(255, 255, 255, 0.95);
        }

        .message-content code {
            background: var(--bg-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        /* Chat Input */
        .chat-input-container {
            padding: 1.5rem 2rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            max-width: 900px;
            margin: 0 auto;
        }

        .photo-btn {
            width: 56px;
            height: 56px;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .photo-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .photo-btn:active {
            transform: translateY(0);
        }

        .photo-btn svg {
            stroke-width: 2.5;
        }

        #chat-input {
            flex: 1;
            padding: 1rem 1.25rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 0.9375rem;
            font-weight: 400;
            resize: none;
            min-height: 56px;
            max-height: 200px;
            line-height: 1.6;
            transition: all 0.2s ease;
        }

        #chat-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(91, 142, 244, 0.1);
        }

        #chat-input::placeholder {
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .send-btn {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(91, 142, 244, 0.3);
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(91, 142, 244, 0.4);
        }

        .send-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(91, 142, 244, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            animation: modalSlideIn 0.3s ease;
            box-sizing: border-box;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            font-size: 0.6875rem;
            margin-bottom: 1.25rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 1.25rem;
            max-width: 100%;
            overflow: hidden;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            max-width: 100%;
            min-width: 0;
            padding: 0.875rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow: hidden;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(91, 142, 244, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }

        .form-group small {
            display: block;
            margin-top: 0.5rem;
            color: var(--text-tertiary);
            font-size: 0.8125rem;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .form-group small a {
            color: var(--accent);
            text-decoration: none;
            word-break: break-word;
        }

        .form-group small a:hover {
            text-decoration: underline;
        }

        .save-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(91, 142, 244, 0.3);
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(91, 142, 244, 0.4);
        }

        .save-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(91, 142, 244, 0.3);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border);
        }

        /* Loading indicator */
        .typing-indicator {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-8px);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar with daily stats -->
        <aside class="sidebar">
            <div class="logo">
                <h1>Mirror</h1>
                <p class="tagline">Accountability in conversation</p>
            </div>
            
            <div class="daily-stats">
                <div class="date-display">
                    <span class="day"></span>
                    <span class="full-date"></span>
                </div>
                
                <div class="macro-summary">
                    <h3>Today's Macros</h3>
                    <div class="macro-bars">
                        <div class="macro-item">
                            <div class="macro-label">
                                <span>Protein</span>
                                <span class="macro-value"><span id="protein-current">0</span>/<span id="protein-target">120</span>g</span>
                            </div>
                            <div class="macro-bar">
                                <div class="macro-fill protein-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="macro-item">
                            <div class="macro-label">
                                <span>Carbs</span>
                                <span class="macro-value"><span id="carbs-current">0</span>/<span id="carbs-target">200</span>g</span>
                            </div>
                            <div class="macro-bar">
                                <div class="macro-fill carbs-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="macro-item">
                            <div class="macro-label">
                                <span>Fat</span>
                                <span class="macro-value"><span id="fat-current">0</span>/<span id="fat-target">60</span>g</span>
                            </div>
                            <div class="macro-bar">
                                <div class="macro-fill fat-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calories-display">
                        <div>
                            <div class="cal-label">Calories</div>
                            <div class="cal-value">
                                <span id="calories-current">0</span><span style="color: var(--text-tertiary); font-size: 1.125rem; margin: 0 0.25rem;">/</span><span id="calories-target" style="color: var(--text-secondary); font-size: 1.125rem;">2000</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.05);">
                            <span id="deficit-label" style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Deficit</span>
                            <span id="deficit-value" style="font-size: 0.875rem; font-weight: 700;">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="weekly-summary">
                    <h3>This Week</h3>
                    <div class="week-dates" id="week-dates">
                        <span id="week-range">Mon 23 - Sun 29 Dec</span>
                    </div>
                    <div class="weekly-stats">
                        <div class="weekly-stat-item">
                            <div class="weekly-stat-label">Budget</div>
                            <div class="weekly-stat-value">
                                <span id="weekly-calories">0</span><span style="color: var(--text-tertiary); margin: 0 0.25rem; font-size: 0.75rem;">/</span><span id="weekly-budget" style="color: var(--text-secondary); font-size: 0.8125rem;">13132</span>
                            </div>
                        </div>
                        <div class="weekly-stat-item">
                            <div class="weekly-stat-label">Remaining</div>
                            <div class="weekly-stat-value" id="weekly-remaining">13132 cal</div>
                        </div>
                        <div class="weekly-stat-item">
                            <div class="weekly-stat-label">Days</div>
                            <div class="weekly-stat-value" id="days-logged">0 / 7</div>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn" id="btn-today">How's today?</button>
                    <button class="action-btn" id="btn-suggestions">Meal suggestions</button>
                    <button class="action-btn" id="btn-supplements">About supplements</button>
                    <button class="action-btn" id="btn-check-safety">Check my supplements</button>
                </div>
            </div>
            
            <div class="settings-link">
                <button id="btn-settings">‚öô Settings</button>
            </div>
        </aside>
        
        <!-- Main chat area -->
        <main class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message system-message">
                    <div class="message-content">
                        <p>Welcome to your Accountability Mirror. I'm here to support your health and fitness journey with real-time advice, macro tracking, and motivation.</p>
                        <p>Tell me what you're eating, ask questions, share your struggles - let's work on this together.</p>
                        <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(91, 142, 244, 0.2); font-size: 0.875rem; color: var(--text-secondary);"><strong style="color: var(--accent);">‚ö†Ô∏è Privacy Notice:</strong> All your data (API key, settings, macros) is stored in YOUR BROWSER ONLY. It never leaves your device. <strong>If you clear browser data or use a different browser, you'll need to set up again.</strong> No cloud sync, maximum privacy. <strong>üí° Tip: Use "Export Settings" in Settings to back up your data!</strong> <a href="https://github.com/Woostmeister/accountability-mirror/blob/main/PRIVACY.md" target="_blank" style="color: var(--accent); text-decoration: underline;">Read full privacy policy</a></p>
                    </div>
                </div>
                <div class="message system-message">
                    <div class="message-content">
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">‚öôÔ∏è First Time Here?</p>
                        <p style="font-size: 0.9rem;">Please configure your API key in Settings first. Click the ‚öôÔ∏è Settings button on the left.</p>
                        <p style="font-size: 0.875rem; margin-top: 0.75rem; color: var(--text-secondary);">
                            <strong>Need help?</strong> <a href="https://github.com/Woostmeister/accountability-mirror/blob/main/GETTING-STARTED.md" target="_blank" style="color: var(--accent); text-decoration: underline;">Getting Started Guide</a> ‚Ä¢ <a href="https://github.com/Woostmeister/accountability-mirror/blob/main/PRIVACY.md" target="_blank" style="color: var(--accent); text-decoration: underline;">Privacy Info</a>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <input type="file" id="photo-input" accept="image/*" style="display: none;">
                    <button id="photo-btn" class="photo-btn" title="Upload food photo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                    </button>
                    <textarea 
                        id="chat-input" 
                        placeholder="Tell me what you ate, ask a question, or share how you're feeling..."
                        rows="1"
                    ></textarea>
                    <button id="send-btn" class="send-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                </div>
                <div id="photo-preview" style="display: none; margin-top: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 8px;">
                        <img id="preview-img" style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                        <span id="preview-name" style="flex: 1; font-size: 0.9rem; color: var(--text-secondary);"></span>
                        <button id="remove-photo" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" id="close-settings">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: rgba(91, 142, 244, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; color: var(--accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        Important: Data Storage
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
                        <strong>All settings saved in THIS BROWSER ONLY.</strong> Different browsers = different setups. Clearing browser data = losing everything. No cloud backup. <a href="https://github.com/Woostmeister/accountability-mirror/blob/main/PRIVACY.md" target="_blank" style="color: var(--accent); text-decoration: underline;">Learn more</a>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>API Configuration</h3>
                    <div style="background: var(--system-msg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid var(--accent);">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">üîë Need an API key?</div>
                        <div style="font-size: 0.875rem; line-height: 1.5; margin-bottom: 0.5rem;">
                            Get yours in 2 minutes at <a href="https://console.anthropic.com" target="_blank" style="color: var(--accent); text-decoration: underline;">console.anthropic.com</a>
                        </div>
                        <div style="font-size: 0.8125rem; color: var(--text-tertiary);">
                            Cost: ~¬£0.003 per message. ¬£5 lasts 6+ months.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="api-provider">AI Provider</label>
                        <select id="api-provider">
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="openai">ChatGPT (OpenAI)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="api-key">API Key</label>
                        <input type="password" id="api-key" placeholder="Enter your API key">
                        <small>Stored in YOUR browser only (localStorage). If you clear cache or use a different browser, you'll need to re-enter it. Get yours at <a href="https://console.anthropic.com" target="_blank" style="color: var(--accent);">console.anthropic.com</a></small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Your Profile</h3>
                    <div class="form-group">
                        <label for="user-sex">Sex</label>
                        <select id="user-sex">
                            <option value="">Select...</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-age">Age</label>
                        <input type="number" id="user-age" placeholder="e.g. 58">
                    </div>
                    <div class="form-group">
                        <label for="user-weight">Current Weight (kg)</label>
                        <input type="number" id="user-weight" placeholder="e.g. 80" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="user-height">Height (cm)</label>
                        <input type="number" id="user-height" placeholder="e.g. 165">
                        <small>Used to calculate maintenance calories</small>
                    </div>
                    <div class="form-group">
                        <label for="user-activity">Activity Level</label>
                        <select id="user-activity">
                            <option value="sedentary">Sedentary (little/no exercise)</option>
                            <option value="light">Lightly active (1-3 days/week)</option>
                            <option value="moderate" selected>Moderately active (3-5 days/week)</option>
                            <option value="very">Very active (6-7 days/week)</option>
                            <option value="extra">Extra active (athlete/physical job)</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Weight Loss Goal</h3>
                    <div class="form-group">
                        <label for="target-weight">Target Weight (kg)</label>
                        <input type="number" id="target-weight" placeholder="e.g. 60" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="target-date">Target Date</label>
                        <input type="date" id="target-date">
                        <small>When do you want to reach your goal?</small>
                    </div>
                    <div class="form-group">
                        <button type="button" id="calculate-plan" style="width: 100%; padding: 0.75rem; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                            Calculate My Plan
                        </button>
                    </div>
                </div>
                
                <div class="settings-section" id="calculated-plan" style="display: none;">
                    <h3>Your Personalized Plan</h3>
                    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            <strong>Weight to lose:</strong> <span id="plan-weight-loss"></span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            <strong>Time available:</strong> <span id="plan-time"></span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            <strong>Rate needed:</strong> <span id="plan-rate"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Maintenance Calories (TDEE)</label>
                        <input type="number" id="maintenance-calories" readonly style="background: var(--bg-tertiary); cursor: not-allowed;">
                        <small>Calculated from your age, weight, height, and activity level</small>
                    </div>
                    <div class="form-group">
                        <label>Daily Calorie Goal</label>
                        <input type="number" id="calorie-goal" readonly style="background: var(--bg-tertiary); cursor: not-allowed;">
                        <small>Calculated to hit your target weight by target date</small>
                    </div>
                    <div class="form-group">
                        <label>Daily Deficit</label>
                        <input type="text" id="calculated-deficit" readonly style="background: var(--bg-tertiary); cursor: not-allowed;">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Daily Macro Targets</h3>
                    <div style="background: var(--system-msg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                        ‚ÑπÔ∏è These are calculated automatically based on your weight and goals. They'll update as you lose weight!
                    </div>
                    <div class="form-group">
                        <label for="target-protein">Protein Target (g)</label>
                        <input type="number" id="target-protein" value="120" readonly style="background: var(--bg-tertiary); cursor: not-allowed;">
                        <small>Auto-calculated: 1.6g per kg bodyweight for muscle preservation</small>
                    </div>
                    <div class="form-group">
                        <label>Protein Acceptable Range</label>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div style="flex: 1;">
                                <label for="protein-min" style="font-size: 0.85rem; color: var(--text-tertiary);">Min (g)</label>
                                <input type="number" id="protein-min" value="96" readonly style="background: var(--bg-tertiary); cursor: not-allowed;">
                            </div>
                            <span style="color: var(--text-tertiary); padding-top: 1.5rem;">to</span>
                            <div style="flex: 1;">
                                <label for="protein-max" style="font-size: 0.85rem; color: var(--text-tertiary);">Max (g)</label>
                                <input type="number" id="protein-max" value="128" readonly style="background: var(--bg-tertiary); cursor: not-allowed;">
                            </div>
                        </div>
                        <small>Auto-calculated: 1.2-1.6g per kg bodyweight</small>
                    </div>
                    <div class="form-group">
                        <label for="target-fat">Fat Minimum (g)</label>
                        <input type="number" id="target-fat" value="60" readonly style="background: var(--bg-tertiary); cursor: not-allowed;">
                        <small>Auto-calculated: 0.8g per kg bodyweight for hormones</small>
                    </div>
                    <div class="form-group">
                        <label for="target-carbs">Carbs (g)</label>
                        <input type="number" id="target-carbs" value="200" readonly style="background: var(--bg-tertiary); cursor: not-allowed;">
                        <small>Remainder of calories after protein and fat</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Additional Information</h3>
                    <div class="form-group">
                        <label for="user-goals">Primary Goals</label>
                        <textarea id="user-goals" rows="3" placeholder="e.g. Lose 10kg, build muscle, improve energy, better sleep quality..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="user-context">Additional Context</label>
                        <textarea id="user-context" rows="4" placeholder="Work schedule, dietary preferences, fitness level, any limitations..."></textarea>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Medications & Supplements</h3>
                    <div class="form-group">
                        <label for="user-medications">Current Medications</label>
                        <textarea id="user-medications" rows="3" placeholder="e.g. Tamoxifen 20mg daily, Levothyroxine 50mcg..."></textarea>
                        <small>‚ö†Ô∏è List all prescription medications - this helps check for supplement interactions</small>
                    </div>
                    <div class="form-group">
                        <label for="user-supplements">Current Supplements</label>
                        <textarea id="user-supplements" rows="4" placeholder="e.g. Vitamin D 2000IU, Omega-3 1000mg, Creatine 5g, Magnesium glycinate 400mg..."></textarea>
                        <small>List everything you take - vitamins, minerals, herbs, protein powder, etc.</small>
                    </div>
                    <div class="form-group">
                        <label for="user-conditions">Medical Conditions / Allergies</label>
                        <textarea id="user-conditions" rows="2" placeholder="e.g. Breast cancer (on Tamoxifen), hypothyroidism, allergies to..."></textarea>
                        <small>Optional - helps with personalized advice and safety checks</small>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <button onclick="exportSettings()" style="flex: 1; padding: 0.875rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.875rem; font-weight: 500; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--accent)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                        <span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export Settings
                        </span>
                    </button>
                    <button onclick="importSettings()" style="flex: 1; padding: 0.875rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.875rem; font-weight: 500; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--accent)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border)'; this.style.transform='translateY(0)'">
                        <span style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Import Settings
                        </span>
                    </button>
                </div>
                
                <button class="save-btn" id="save-settings">Save Settings</button>
            </div>
        </div>
    </div>
    
    <script>
        // State management
        const state = {
            macros: {
                protein: { current: 0, target: 120, min: 96, max: 128 },
                carbs: { current: 0, target: 200 },
                fat: { current: 0, target: 60 }
            },
            calories: { current: 0, target: 2000, maintenance: 2500 },
            weeklyData: {
                weekStart: null,
                totalCalories: 0,
                totalProtein: 0,
                weeklyBudget: 0,
                daysLogged: 0,
                days: {} // Store data for each day of the week
            },
            conversationHistory: [],
            uploadedPhoto: null, // Store photo for next message
            settings: {
                apiProvider: 'claude',
                apiKey: '',
                userSex: '',
                userAge: '',
                userWeight: '',
                userHeight: '',
                userActivity: 'moderate',
                targetWeight: '',
                targetDate: '',
                userGoals: '',
                userContext: '',
                userMedications: '',
                userSupplements: '',
                userConditions: ''
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
            loadSettings();
            updateDateDisplay();
            loadTodaysMacros();
        });

        function initializeApp() {
            console.log('Accountability Mirror initialized');
        }

        // Event Listeners
        function setupEventListeners() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            sendBtn.addEventListener('click', () => {
                handleSendMessage();
            });
            
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            
            // Auto-resize textarea
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = chatInput.scrollHeight + 'px';
            });
            
            // Quick action buttons
            document.getElementById('btn-today').addEventListener('click', () => {
                sendPredefinedMessage("How am I doing today? Give me a summary of my progress and any suggestions.");
            });
            
            document.getElementById('btn-suggestions').addEventListener('click', () => {
                sendPredefinedMessage("Based on my current macros, what should I eat next to stay on track?");
            });
            
            document.getElementById('btn-supplements').addEventListener('click', () => {
                sendPredefinedMessage("Tell me about supplements that are actually evidence-based and worth taking for my goals.");
            });
            
            document.getElementById('btn-check-safety').addEventListener('click', () => {
                if (!state.settings.userMedications && !state.settings.userSupplements) {
                    sendPredefinedMessage("I'd like to check for supplement safety, but I haven't entered my medications or supplements yet. What should I do?");
                } else {
                    sendPredefinedMessage("Please review my current medications and supplements for any dangerous interactions or contraindications. Flag anything I should be concerned about, especially related to my medications.");
                }
            });
            
            // Settings
            document.getElementById('btn-settings').addEventListener('click', () => {
                openSettings();
            });
            
            document.getElementById('close-settings').addEventListener('click', () => {
                closeSettings();
            });
            
            document.getElementById('save-settings').addEventListener('click', () => {
                saveSettings();
            });
            
            // Close modal on outside click
            document.getElementById('settings-modal').addEventListener('click', (e) => {
                if (e.target.id === 'settings-modal') {
                    closeSettings();
                }
            });
            
            // Update deficit calculation when calorie fields change
            document.getElementById('maintenance-calories').addEventListener('input', updateDeficitCalculation);
            document.getElementById('calorie-goal').addEventListener('input', updateDeficitCalculation);
            
            // Calculate plan button
            document.getElementById('calculate-plan').addEventListener('click', calculatePersonalizedPlan);
            
            // Photo upload
            document.getElementById('photo-btn').addEventListener('click', () => {
                document.getElementById('photo-input').click();
            });
            
            document.getElementById('photo-input').addEventListener('change', handlePhotoUpload);
            
            document.getElementById('remove-photo').addEventListener('click', () => {
                state.uploadedPhoto = null;
                document.getElementById('photo-preview').style.display = 'none';
                document.getElementById('photo-input').value = '';
            });
        }

        // Date display
        function updateDateDisplay() {
            const now = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.querySelector('.date-display .day').textContent = days[now.getDay()];
            document.querySelector('.date-display .full-date').textContent = 
                `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
        }
        
        // Photo handling
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }
            
            // Read file as base64
            const reader = new FileReader();
            reader.onload = (e) => {
                state.uploadedPhoto = {
                    data: e.target.result.split(',')[1], // Get base64 part only
                    type: file.type,
                    name: file.name
                };
                
                // Show preview
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-name').textContent = file.name;
                document.getElementById('photo-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Macro management
        function loadTodaysMacros() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem(`macros_${today}`);
            
            if (stored) {
                const data = JSON.parse(stored);
                state.macros = data;
                updateMacroDisplay();
            } else {
                state.macros.protein.current = 0;
                state.macros.carbs.current = 0;
                state.macros.fat.current = 0;
                state.calories.current = 0;
                updateMacroDisplay();
            }
        }

        function saveTodaysMacros() {
            const today = new Date().toDateString();
            localStorage.setItem(`macros_${today}`, JSON.stringify(state.macros));
            
            // Cleanup old data (keep last 30 days only)
            cleanupOldMacroData();
        }
        
        function cleanupOldMacroData() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // Get all localStorage keys
            const keysToDelete = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                // Check if it's a macros_ key
                if (key && key.startsWith('macros_')) {
                    // Extract the date string
                    const dateStr = key.replace('macros_', '');
                    const keyDate = new Date(dateStr);
                    
                    // If older than 30 days, mark for deletion
                    if (keyDate < thirtyDaysAgo) {
                        keysToDelete.push(key);
                    }
                }
            }
            
            // Delete old entries
            keysToDelete.forEach(key => {
                localStorage.removeItem(key);
                console.log(`Cleaned up old macro data: ${key}`);
            });
        }

        function updateMacros(protein, carbs, fat) {
            state.macros.protein.current += protein;
            state.macros.carbs.current += carbs;
            state.macros.fat.current += fat;
            
            state.calories.current = Math.round(
                (state.macros.protein.current * 4) +
                (state.macros.carbs.current * 4) +
                (state.macros.fat.current * 9)
            );
            
            updateMacroDisplay();
            saveTodaysMacros();
        }

        function updateMacroDisplay() {
            // Update protein with range indicator
            const proteinCurrent = Math.round(state.macros.protein.current);
            document.getElementById('protein-current').textContent = proteinCurrent;
            
            // Show range instead of single target
            const proteinMin = state.macros.protein.min || state.macros.protein.target;
            const proteinMax = state.macros.protein.max || state.macros.protein.target;
            if (proteinMin !== proteinMax) {
                document.getElementById('protein-target').textContent = `${proteinMin}-${proteinMax}`;
            } else {
                document.getElementById('protein-target').textContent = state.macros.protein.target;
            }
            
            // Use mid-point of range for progress bar
            const proteinTarget = (proteinMin + proteinMax) / 2;
            const proteinPercent = Math.min((state.macros.protein.current / proteinTarget) * 100, 100);
            document.querySelector('.protein-fill').style.width = `${proteinPercent}%`;
            
            document.getElementById('carbs-current').textContent = Math.round(state.macros.carbs.current);
            document.getElementById('carbs-target').textContent = state.macros.carbs.target;
            const carbsPercent = Math.min((state.macros.carbs.current / state.macros.carbs.target) * 100, 100);
            document.querySelector('.carbs-fill').style.width = `${carbsPercent}%`;
            
            document.getElementById('fat-current').textContent = Math.round(state.macros.fat.current);
            document.getElementById('fat-target').textContent = state.macros.fat.target;
            const fatPercent = Math.min((state.macros.fat.current / state.macros.fat.target) * 100, 100);
            document.querySelector('.fat-fill').style.width = `${fatPercent}%`;
            
            document.getElementById('calories-current').textContent = state.calories.current;
            document.getElementById('calories-target').textContent = state.calories.target;
            
            // Calculate and display deficit/surplus
            const remaining = state.calories.target - state.calories.current;
            const deficitLabel = document.getElementById('deficit-label');
            const deficitValue = document.getElementById('deficit-value');
            
            if (remaining > 0) {
                deficitLabel.textContent = 'Remaining';
                deficitValue.textContent = `${remaining} cal`;
                deficitValue.style.color = 'var(--carbs-color)';
            } else if (remaining < 0) {
                deficitLabel.textContent = 'Over target';
                deficitValue.textContent = `${Math.abs(remaining)} cal`;
                deficitValue.style.color = 'var(--protein-color)';
            } else {
                deficitLabel.textContent = 'Perfect!';
                deficitValue.textContent = 'On target';
                deficitValue.style.color = 'var(--fat-color)';
            }
            
            // Update weekly summary
            updateWeeklyDisplay();
        }
        
        function updateWeeklyDisplay() {
            // Calculate week start (Monday)
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Adjust for Sunday
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() + diff);
            weekStart.setHours(0, 0, 0, 0);
            
            // Format week range
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const startStr = `${weekStart.getDate()} ${months[weekStart.getMonth()]}`;
            const endStr = `${weekEnd.getDate()} ${months[weekEnd.getMonth()]}`;
            
            document.getElementById('week-range').textContent = `Mon ${startStr} - Sun ${endStr}`;
            
            // Load weekly data
            loadWeeklyData(weekStart);
            
            // Calculate weekly budget
            const weeklyBudget = state.calories.target * 7;
            state.weeklyData.weeklyBudget = weeklyBudget;
            
            // Display weekly stats
            document.getElementById('weekly-calories').textContent = state.weeklyData.totalCalories;
            document.getElementById('weekly-budget').textContent = weeklyBudget;
            
            const remaining = weeklyBudget - state.weeklyData.totalCalories;
            const remainingEl = document.getElementById('weekly-remaining');
            if (remaining >= 0) {
                remainingEl.textContent = `${remaining} cal`;
                remainingEl.style.color = 'var(--fat-color)';
            } else {
                remainingEl.textContent = `${Math.abs(remaining)} over`;
                remainingEl.style.color = 'var(--protein-color)';
            }
            
            document.getElementById('days-logged').textContent = `${state.weeklyData.daysLogged} / 7`;
        }
        
        function loadWeeklyData(weekStart) {
            // Load data for the current week from localStorage
            state.weeklyData.totalCalories = 0;
            state.weeklyData.totalProtein = 0;
            state.weeklyData.daysLogged = 0;
            state.weeklyData.days = {};
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                
                // Only count up to today
                if (date > today) break;
                
                const dateStr = date.toDateString();
                const dayData = localStorage.getItem(`macros_${dateStr}`);
                
                if (dayData) {
                    const data = JSON.parse(dayData);
                    const dayCalories = (data.protein.current * 4) + (data.carbs.current * 4) + (data.fat.current * 9);
                    
                    if (dayCalories > 0) {
                        state.weeklyData.totalCalories += Math.round(dayCalories);
                        state.weeklyData.totalProtein += data.protein.current;
                        state.weeklyData.daysLogged++;
                        state.weeklyData.days[dateStr] = {
                            calories: dayCalories,
                            protein: data.protein.current
                        };
                    }
                }
            }
        }

        // Chat functionality
        async function handleSendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            // Allow sending if there's a message OR a photo
            if (!message && !state.uploadedPhoto) return;
            
            if (!state.settings.apiKey) {
                addAssistantMessage("Please configure your API key in Settings first. Click the ‚öô Settings button on the left.");
                return;
            }
            
            // Add user message to chat
            if (state.uploadedPhoto) {
                addUserMessage(message || 'üì∑ Uploaded food photo', true);
            } else {
                addUserMessage(message);
            }
            
            input.value = '';
            input.style.height = 'auto';
            
            showTypingIndicator();
            
            try {
                const response = await getAIResponse(message);
                removeTypingIndicator();
                addAssistantMessage(response.message);
                
                if (response.macros) {
                    updateMacros(response.macros.protein, response.macros.carbs, response.macros.fat);
                }
            } catch (error) {
                removeTypingIndicator();
                addAssistantMessage(`Sorry, I encountered an error: ${error.message}. Please check your API key in Settings.`);
            }
        }

        function sendPredefinedMessage(message) {
            document.getElementById('chat-input').value = message;
            handleSendMessage();
        }

        function addUserMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <p>${escapeHtml(text)}</p>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            state.conversationHistory.push({
                role: 'user',
                content: text
            });
        }

        function addAssistantMessage(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message';
            
            const formattedText = formatMessage(text);
            
            // Store the raw text in a data attribute for copying
            messageDiv.innerHTML = `
                <div class="message-content" data-raw-text="${escapeHtml(text)}">
                    ${formattedText}
                    <button class="copy-btn" onclick="copyMessageToClipboard(this)" title="Copy to clipboard">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        <span class="copy-label">Copy</span>
                    </button>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            state.conversationHistory.push({
                role: 'assistant',
                content: text
            });
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const indicator = document.createElement('div');
            indicator.className = 'message assistant-message typing-message';
            indicator.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            messagesContainer.appendChild(indicator);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.querySelector('.typing-message');
            if (indicator) {
                indicator.remove();
            }
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // AI API Integration
        async function getAIResponse(userMessage) {
            const systemPrompt = buildSystemPrompt();
            
            if (state.settings.apiProvider === 'claude') {
                return await getClaudeResponse(systemPrompt, userMessage);
            } else {
                return await getOpenAIResponse(systemPrompt, userMessage);
            }
        }

        function buildSystemPrompt() {
            const deficit = state.calories.maintenance - state.calories.target;
            const deficitText = deficit > 0 
                ? `${deficit} cal deficit for ~${(deficit / 500 * 0.5).toFixed(1)}kg/week loss` 
                : deficit < 0 
                    ? `${Math.abs(deficit)} cal surplus for muscle gain`
                    : 'maintenance calories';
            
            const proteinRange = state.macros.protein.min !== state.macros.protein.max 
                ? `${state.macros.protein.min}-${state.macros.protein.max}g (range)`
                : `${state.macros.protein.target}g`;
            
            const weeklyRemaining = state.weeklyData.weeklyBudget - state.weeklyData.totalCalories;
            const weeklyContext = state.weeklyData.daysLogged > 0 
                ? `\nWeekly Progress: ${state.weeklyData.totalCalories} / ${state.weeklyData.weeklyBudget} cal (${weeklyRemaining} remaining, ${state.weeklyData.daysLogged}/7 days logged)`
                : '';
            
            const currentMacros = `
Current macros today:
- Protein: ${Math.round(state.macros.protein.current)}g / ${proteinRange}
- Carbs: ${Math.round(state.macros.carbs.current)}g / ${state.macros.carbs.target}g
- Fat: ${Math.round(state.macros.fat.current)}g / ${state.macros.fat.target}g
- Calories: ${state.calories.current} / ${state.calories.target} (${deficitText})${weeklyContext}
`;

            const medicationInfo = state.settings.userMedications || state.settings.userSupplements || state.settings.userConditions
                ? `
CRITICAL MEDICATION & SUPPLEMENT SAFETY INFORMATION:
${state.settings.userMedications ? `Current Medications: ${state.settings.userMedications}` : ''}
${state.settings.userSupplements ? `Current Supplements: ${state.settings.userSupplements}` : ''}
${state.settings.userConditions ? `Medical Conditions: ${state.settings.userConditions}` : ''}

IMPORTANT SAFETY RULES:
- ALWAYS check for drug-supplement interactions before recommending supplements
- For Tamoxifen users: DO NOT recommend black pepper/piperine, curcumin/turmeric supplements, ashwagandha, St John's Wort, or high-dose antioxidants (can interfere with treatment)
- If user asks about supplements, cross-check against their medications and WARN about any potential interactions
- When analyzing uploaded supplement photos, flag any contraindications immediately
- Be especially cautious with: blood thinners, hormone therapies, immunosuppressants, thyroid medications
- Encourage consulting with oncologist/doctor before starting ANY new supplement when on serious medications
`
                : '';

            const userContext = state.settings.userAge || state.settings.userWeight || state.settings.userGoals || state.settings.userContext
                ? `
User context:
${state.settings.userAge ? `- Age: ${state.settings.userAge}` : ''}
${state.settings.userWeight ? `- Weight: ${state.settings.userWeight}kg` : ''}
${state.settings.userGoals ? `- Goals: ${state.settings.userGoals}` : ''}
${state.settings.userContext ? `- Additional context: ${state.settings.userContext}` : ''}
`
                : '';

            return `You are an accountability coach for health, fitness, and nutrition. You provide supportive, evidence-based guidance with a conversational, motivating tone.

${currentMacros}

${medicationInfo}

${userContext}

When the user mentions food they've eaten:
1. Estimate the macros (protein, carbs, fat in grams)
2. Provide feedback on how it fits their goals
3. Respond with your message AND include macro data in this exact format at the end:
   MACROS: protein=X carbs=Y fat=Z

For example: "That's a great breakfast choice! Scrambled eggs with toast gives you solid protein to start the day.

MACROS: protein=25 carbs=30 fat=15"

When analyzing uploaded photos of food labels or supplements:
1. Read all visible text carefully
2. Extract macros if it's a food label
3. If it's a supplement label, check ingredients against their medications
4. Warn immediately about any contraindications or interactions

Guidelines:
- Be supportive and realistic, not preachy
- WEEKLY FLEXIBILITY: A daily "fail" doesn't matter if the weekly total is on track - emphasize this!
- If they're over today but under budget for the week, reassure them
- Protein ranges are acceptable targets - anywhere in the range is success
- Offer practical swaps and suggestions
- Consider their age, goals, and context
- Be honest about what works and what doesn't
- PRIORITIZE SAFETY: Always check supplement-medication interactions
- When discussing supplements, focus on evidence-based options that are SAFE for their medication profile
- Help them make decisions in the moment (temptations, cravings, fatigue)
- Celebrate progress and consistency over perfection
- Use UK terminology and foods

Keep responses conversational and not too long unless they ask for detailed information.`;
        }

        async function getClaudeResponse(systemPrompt, userMessage) {
            console.log('=== Claude API Call Debug ===');
            console.log('API Key (first 10 chars):', state.settings.apiKey.substring(0, 10));
            console.log('Has photo:', !!state.uploadedPhoto);
            
            // Build message content
            let messageContent;
            if (state.uploadedPhoto) {
                // Multi-part message with image
                messageContent = [
                    {
                        type: 'image',
                        source: {
                            type: 'base64',
                            media_type: state.uploadedPhoto.type,
                            data: state.uploadedPhoto.data
                        }
                    },
                    {
                        type: 'text',
                        text: userMessage || 'Please analyze this food label and tell me the macros (protein, carbs, fat in grams). If it shows serving size, tell me that too.'
                    }
                ];
            } else {
                // Text-only message
                messageContent = userMessage;
            }
            
            const messages = [
                ...state.conversationHistory.slice(-10),
                { role: 'user', content: messageContent }
            ];
            
            // Use local proxy to avoid CORS issues
            const apiUrl = '/api/claude';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: systemPrompt,
                        messages: messages,
                        apiKey: state.settings.apiKey
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`API Error: ${errorJson.error?.message || errorText}`);
                    } catch (e) {
                        throw new Error(`API request failed (${response.status}): ${errorText}`);
                    }
                }
                
                const data = await response.json();
                console.log('API response received successfully');
                const messageText = data.content[0].text;
                
                // Clear uploaded photo after successful send
                state.uploadedPhoto = null;
                document.getElementById('photo-preview').style.display = 'none';
                document.getElementById('photo-input').value = '';
                
                return parseAIResponse(messageText);
                
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function getOpenAIResponse(systemPrompt, userMessage) {
            const messages = [
                { role: 'system', content: systemPrompt },
                ...state.conversationHistory.slice(-10),
                { role: 'user', content: userMessage }
            ];
            
            // Use CORS proxy for local file access
            const corsProxy = 'https://corsproxy.io/?';
            const apiUrl = corsProxy + encodeURIComponent('https://api.openai.com/v1/chat/completions');
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.settings.apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: messages,
                    max_tokens: 1024
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.statusText}`);
            }
            
            const data = await response.json();
            const messageText = data.choices[0].message.content;
            
            return parseAIResponse(messageText);
        }

        function parseAIResponse(text) {
            const macroMatch = text.match(/MACROS:\s*protein=(\d+(?:\.\d+)?)\s*carbs=(\d+(?:\.\d+)?)\s*fat=(\d+(?:\.\d+)?)/i);
            
            let macros = null;
            let message = text;
            
            if (macroMatch) {
                macros = {
                    protein: parseFloat(macroMatch[1]),
                    carbs: parseFloat(macroMatch[2]),
                    fat: parseFloat(macroMatch[3])
                };
                
                message = text.replace(/MACROS:.*$/i, '').trim();
            }
            
            return { message, macros };
        }

        // Settings management
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            loadSettingsToForm();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        // Calculate personalized plan based on goals
        function calculatePersonalizedPlan() {
            // Get user inputs
            const sex = document.getElementById('user-sex').value;
            const age = parseInt(document.getElementById('user-age').value);
            const weight = parseFloat(document.getElementById('user-weight').value);
            const height = parseInt(document.getElementById('user-height').value);
            const activity = document.getElementById('user-activity').value;
            const targetWeight = parseFloat(document.getElementById('target-weight').value);
            const targetDate = document.getElementById('target-date').value;
            
            // Validate inputs
            if (!sex || !age || !weight || !height || !targetWeight || !targetDate) {
                alert('Please fill in all profile and goal fields');
                return;
            }
            
            // Calculate BMR (Mifflin-St Jeor equation)
            let bmr;
            if (sex === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
            
            // Calculate TDEE (maintenance calories)
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                very: 1.725,
                extra: 1.9
            };
            const tdee = Math.round(bmr * activityMultipliers[activity]);
            
            // Calculate weight loss needed
            const weightToLose = weight - targetWeight;
            
            // Calculate days available
            const today = new Date();
            const target = new Date(targetDate);
            const daysAvailable = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            const weeksAvailable = (daysAvailable / 7).toFixed(1);
            
            if (daysAvailable <= 0) {
                alert('Target date must be in the future!');
                return;
            }
            
            if (weightToLose <= 0) {
                alert('Target weight must be less than current weight for weight loss');
                return;
            }
            
            // Calculate required rate (kg/week)
            const rateNeeded = weightToLose / (daysAvailable / 7);
            
            // Calculate required deficit (3500 cal = 0.45kg, so ~7700 cal = 1kg)
            const dailyDeficitNeeded = Math.round((weightToLose * 7700) / daysAvailable);
            
            // Check if goal is realistic
            let warning = '';
            if (rateNeeded > 1.0) {
                warning = '‚ö†Ô∏è This rate is very aggressive (>1kg/week). Consider a longer timeframe for sustainable loss.';
            } else if (rateNeeded < 0.25) {
                warning = '‚ÑπÔ∏è This is a very gradual rate (<0.25kg/week). You could reach your goal faster if desired.';
            }
            
            // Calculate daily calorie goal
            const dailyGoal = Math.round(tdee - dailyDeficitNeeded);
            
            // Safety check - don't go below 1200 for women, 1500 for men
            const minCalories = sex === 'female' ? 1200 : 1500;
            if (dailyGoal < minCalories) {
                alert(`This goal requires eating only ${dailyGoal} calories/day, which is below the safe minimum of ${minCalories}. Please choose a later target date.`);
                return;
            }
            
            // Calculate macros based on current weight
            const proteinTarget = Math.round(weight * 1.6); // 1.6g per kg
            const proteinMin = Math.round(weight * 1.2); // 1.2g per kg
            const proteinMax = Math.round(weight * 2.0); // 2.0g per kg
            const fatTarget = Math.round(weight * 0.8); // 0.8g per kg for hormones
            
            // Remaining calories for carbs
            const proteinCals = proteinTarget * 4;
            const fatCals = fatTarget * 9;
            const remainingCals = dailyGoal - proteinCals - fatCals;
            const carbsTarget = Math.round(remainingCals / 4);
            
            // Update the UI
            document.getElementById('plan-weight-loss').textContent = `${weightToLose.toFixed(1)}kg`;
            document.getElementById('plan-time').textContent = `${weeksAvailable} weeks (${daysAvailable} days)`;
            document.getElementById('plan-rate').textContent = `${rateNeeded.toFixed(2)}kg/week ${warning}`;
            
            document.getElementById('maintenance-calories').value = tdee;
            document.getElementById('calorie-goal').value = dailyGoal;
            document.getElementById('calculated-deficit').value = `${dailyDeficitNeeded} cal deficit (~${rateNeeded.toFixed(2)}kg/week loss)`;
            
            document.getElementById('target-protein').value = proteinTarget;
            document.getElementById('protein-min').value = proteinMin;
            document.getElementById('protein-max').value = proteinMax;
            document.getElementById('target-fat').value = fatTarget;
            document.getElementById('target-carbs').value = carbsTarget;
            
            // Show the calculated plan section
            document.getElementById('calculated-plan').style.display = 'block';
            
            // Scroll to show the plan
            document.getElementById('calculated-plan').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function loadSettings() {
            const stored = localStorage.getItem('settings');
            if (stored) {
                state.settings = { ...state.settings, ...JSON.parse(stored) };
            }
            
            const storedTargets = localStorage.getItem('macroTargets');
            if (storedTargets) {
                const targets = JSON.parse(storedTargets);
                state.macros.protein.target = targets.protein;
                state.macros.protein.min = targets.proteinMin || targets.protein;
                state.macros.protein.max = targets.proteinMax || targets.protein;
                state.macros.carbs.target = targets.carbs;
                state.macros.fat.target = targets.fat;
                state.calories.target = targets.calories || targets.calorieTarget || 2000;
                state.calories.maintenance = targets.maintenance || 2500;
                updateMacroDisplay();
            }
        }

        function loadSettingsToForm() {
            document.getElementById('api-provider').value = state.settings.apiProvider;
            document.getElementById('api-key').value = state.settings.apiKey;
            
            // Profile
            document.getElementById('user-sex').value = state.settings.userSex || '';
            document.getElementById('user-age').value = state.settings.userAge || '';
            document.getElementById('user-weight').value = state.settings.userWeight || '';
            document.getElementById('user-height').value = state.settings.userHeight || '';
            document.getElementById('user-activity').value = state.settings.userActivity || 'moderate';
            
            // Goals
            document.getElementById('target-weight').value = state.settings.targetWeight || '';
            document.getElementById('target-date').value = state.settings.targetDate || '';
            
            // Macros (readonly, calculated)
            document.getElementById('target-protein').value = state.macros.protein.target;
            document.getElementById('protein-min').value = state.macros.protein.min || state.macros.protein.target;
            document.getElementById('protein-max').value = state.macros.protein.max || state.macros.protein.target;
            document.getElementById('target-carbs').value = state.macros.carbs.target;
            document.getElementById('target-fat').value = state.macros.fat.target;
            document.getElementById('maintenance-calories').value = state.calories.maintenance;
            document.getElementById('calorie-goal').value = state.calories.target;
            
            // Context
            document.getElementById('user-goals').value = state.settings.userGoals || '';
            document.getElementById('user-context').value = state.settings.userContext || '';
            document.getElementById('user-medications').value = state.settings.userMedications || '';
            document.getElementById('user-supplements').value = state.settings.userSupplements || '';
            document.getElementById('user-conditions').value = state.settings.userConditions || '';
            
            // Show calculated plan if we have the data
            if (state.settings.targetWeight && state.settings.targetDate) {
                document.getElementById('calculated-plan').style.display = 'block';
            }
            
            // Update calculated deficit field
            updateDeficitCalculation();
        }
        
        function updateDeficitCalculation() {
            const maintenance = parseInt(document.getElementById('maintenance-calories').value) || 2500;
            const goal = parseInt(document.getElementById('calorie-goal').value) || 2000;
            const diff = maintenance - goal;
            const deficitField = document.getElementById('calculated-deficit');
            
            if (diff > 0) {
                deficitField.value = `${diff} cal deficit (~${(diff / 500 * 0.5).toFixed(1)}kg/week loss)`;
            } else if (diff < 0) {
                deficitField.value = `${Math.abs(diff)} cal surplus (~${(Math.abs(diff) / 500 * 0.5).toFixed(1)}kg/week gain)`;
            } else {
                deficitField.value = 'Maintenance (no change)';
            }
        }

        function saveSettings() {
            state.settings.apiProvider = document.getElementById('api-provider').value;
            state.settings.apiKey = document.getElementById('api-key').value;
            
            // Profile
            state.settings.userSex = document.getElementById('user-sex').value;
            state.settings.userAge = document.getElementById('user-age').value;
            state.settings.userWeight = document.getElementById('user-weight').value;
            state.settings.userHeight = document.getElementById('user-height').value;
            state.settings.userActivity = document.getElementById('user-activity').value;
            
            // Goals
            state.settings.targetWeight = document.getElementById('target-weight').value;
            state.settings.targetDate = document.getElementById('target-date').value;
            
            // Context
            state.settings.userGoals = document.getElementById('user-goals').value;
            state.settings.userContext = document.getElementById('user-context').value;
            state.settings.userMedications = document.getElementById('user-medications').value;
            state.settings.userSupplements = document.getElementById('user-supplements').value;
            state.settings.userConditions = document.getElementById('user-conditions').value;
            
            localStorage.setItem('settings', JSON.stringify(state.settings));
            
            // Macros (from calculated values)
            state.macros.protein.target = parseInt(document.getElementById('target-protein').value);
            state.macros.protein.min = parseInt(document.getElementById('protein-min').value) || state.macros.protein.target;
            state.macros.protein.max = parseInt(document.getElementById('protein-max').value) || state.macros.protein.target;
            state.macros.carbs.target = parseInt(document.getElementById('target-carbs').value);
            state.macros.fat.target = parseInt(document.getElementById('target-fat').value);
            state.calories.maintenance = parseInt(document.getElementById('maintenance-calories').value);
            state.calories.target = parseInt(document.getElementById('calorie-goal').value);
            
            const targets = {
                protein: state.macros.protein.target,
                proteinMin: state.macros.protein.min,
                proteinMax: state.macros.protein.max,
                carbs: state.macros.carbs.target,
                fat: state.macros.fat.target,
                calories: state.calories.target,
                maintenance: state.calories.maintenance
            };
            
            localStorage.setItem('macroTargets', JSON.stringify(targets));
            
            updateMacroDisplay();
            closeSettings();
            
            // Give feedback about auto-adjusting macros
            const weight = state.settings.userWeight;
            if (weight) {
                addAssistantMessage(`Settings saved! Your plan is personalized for ${weight}kg. As you lose weight, remember to recalculate your plan - your protein needs and calorie targets will adjust automatically!`);
            } else {
                addAssistantMessage("Settings saved! I'm ready to help you with your goals.");
            }
        }

        function exportSettings() {
            const exportData = {
                settings: state.settings,
                macroTargets: {
                    protein: state.macros.protein.target,
                    proteinMin: state.macros.protein.min,
                    proteinMax: state.macros.protein.max,
                    carbs: state.macros.carbs.target,
                    fat: state.macros.fat.target,
                    calories: state.calories.target,
                    maintenance: state.calories.maintenance
                },
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            // Create downloadable JSON file
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `accountability-mirror-settings-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            addAssistantMessage("Settings exported! Your backup file has been downloaded. Keep it safe to restore your settings later.");
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importData = JSON.parse(event.target.result);
                        
                        // Validate it's our export format
                        if (!importData.settings || !importData.macroTargets) {
                            alert('Invalid settings file. Please select a valid Accountability Mirror backup file.');
                            return;
                        }
                        
                        // Import settings
                        state.settings = { ...state.settings, ...importData.settings };
                        localStorage.setItem('settings', JSON.stringify(state.settings));
                        
                        // Import macro targets
                        const targets = importData.macroTargets;
                        state.macros.protein.target = targets.protein;
                        state.macros.protein.min = targets.proteinMin || targets.protein;
                        state.macros.protein.max = targets.proteinMax || targets.protein;
                        state.macros.carbs.target = targets.carbs;
                        state.macros.fat.target = targets.fat;
                        state.calories.target = targets.calories;
                        state.calories.maintenance = targets.maintenance;
                        
                        localStorage.setItem('macroTargets', JSON.stringify(targets));
                        
                        // Reload settings into form
                        loadSettingsToForm();
                        updateMacroDisplay();
                        
                        addAssistantMessage("Settings imported successfully! All your data has been restored.");
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('Failed to import settings. The file may be corrupted or in the wrong format.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            const paragraphs = text.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(p => {
                p = p.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                p = p.replace(/__(.+?)__/g, '<strong>$1</strong>');
                p = p.replace(/`(.+?)`/g, '<code>$1</code>');
                
                return `<p>${p}</p>`;
            }).join('');
        }
        
        function copyMessageToClipboard(button) {
            const messageContent = button.closest('.message-content');
            const rawText = messageContent.getAttribute('data-raw-text');
            
            navigator.clipboard.writeText(rawText).then(() => {
                // Visual feedback
                const label = button.querySelector('.copy-label');
                const originalText = label.textContent;
                label.textContent = 'Copied!';
                button.style.color = 'var(--fat-color)';
                
                setTimeout(() => {
                    label.textContent = originalText;
                    button.style.color = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }
    </script>
</body>
</html>
